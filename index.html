<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werewolf Phygital v4.2</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-lobby: #2c3e50;
            --bg-night: #1a0b2e; /* Ungu Gelap */
            --bg-day: #2980b9;    /* Biru Cerah */
            --bg-vote: #c0392b;   /* Merah */
            --accent: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            background-color: var(--bg-lobby);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.8s ease;
            overflow: hidden;
            user-select: none;
        }

        /* LAYOUT */
        .screen { width: 90%; max-width: 400px; text-align: center; display: flex; flex-direction: column; height: 100%; justify-content: center; }
        .hidden { display: none !important; }
        
        /* TYPOGRAPHY */
        h1 { font-size: 2rem; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
        h2 { font-size: 3.5rem; margin: 10px 0; color: var(--accent); background: rgba(0,0,0,0.3); padding: 5px 20px; border-radius: 15px; display: inline-block; }
        
        /* QUESTION TEXT (Penting untuk Disguised Input) */
        #phaseDesc { 
            font-size: 1.2rem; 
            font-weight: bold;
            color: #ffeb3b;
            margin-bottom: 20px; 
            line-height: 1.4; 
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        /* BUTTONS & INPUT */
        input { padding: 15px; width: 80%; font-size: 1.2rem; border-radius: 8px; border: none; text-align: center; margin-bottom: 10px; text-transform: uppercase; }
        button { background: white; color: #333; border: none; padding: 15px 30px; font-size: 1.1rem; font-weight: bold; border-radius: 50px; cursor: pointer; width: 80%; margin-bottom: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        button:active { transform: translateY(2px); box-shadow: none; }
        button.secondary { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); }

        /* GAME ELEMENTS */
        .phase-icon { font-size: 4rem; margin-bottom: 10px; display: block; }
        .timer-big { font-size: 3rem; font-weight: bold; margin-top: 20px; }
        
        /* PLAYER GRID */
        .player-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            width: 100%; max-height: 40vh; overflow-y: auto; margin: 10px 0;
        }
        .p-card { 
            background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; 
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .p-card.selected { background: var(--accent); color: black; border-color: white; transform: scale(1.05); }
        .p-card.dead { opacity: 0.4; text-decoration: line-through; pointer-events: none; background: #000; }

        /* POPUPS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99; flex-direction: column; justify-content: center; align-items: center; }
        .role-title { font-size: 3rem; color: var(--accent); font-weight: bold; margin: 20px 0; }
        
        .msg-box { background: #2ecc71; color: black; padding: 15px; border-radius: 10px; margin-bottom: 15px; animation: popIn 0.5s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        /* Quiz specific */
        #quizStep1 { animation: popIn 0.3s; }

    </style>
</head>
<body>

    <div id="screenLobby" class="screen">
        <div id="viewLanding">
            <h1>Werewolf<br>Phygital v4.2</h1>
            <p>Edisi Bank Soal & Kuis</p>
            <input type="text" id="inputName" placeholder="NAMA KAMU">
            <button onclick="createRoom()">BUAT ROOM (HOST)</button>
            <button class="secondary" onclick="showJoin()">GABUNG ROOM</button>
        </div>

        <div id="viewJoin" class="hidden">
            <h1>GABUNG</h1>
            <input type="text" id="inputCode" placeholder="KODE ROOM (4 HURUF)" maxlength="4">
            <button onclick="joinRoom()">MASUK</button>
            <button class="secondary" onclick="location.reload()">BATAL</button>
        </div>

        <div id="viewWaiting" class="hidden">
            <p>KODE ROOM:</p>
            <h2 id="dispCode">----</h2>
            <p><span id="pCount">0</span> Pemain Terhubung</p>
            <div id="hostPanel" class="hidden">
                <button onclick="startGame()">MULAI GAME</button>
            </div>
            <p id="waitText">Menunggu Host...</p>
        </div>
    </div>

    <div id="screenGame" class="screen hidden">
        <div style="position: absolute; top: 10px; left: 10px;">
            <button style="padding: 5px 15px; font-size: 0.8rem; width: auto;" onclick="toggleRole()">üëÅÔ∏è PERAN</button>
        </div>

        <div id="privateMsg" class="msg-box hidden"></div>

        <div id="phaseIcon" class="phase-icon">üåô</div>
        <h1 id="phaseTitle">LOADING...</h1>
        
        <div id="phaseDesc">...</div>
        
        <div id="actionArea" class="hidden">
            <div id="playerGrid" class="player-grid"></div>
            <button id="btnAction" onclick="submitAction()">KONFIRMASI</button>
        </div>

        <div id="timerDisplay" class="timer-big">00</div>
    </div>

    <div id="overlayRole" class="overlay hidden" onclick="this.classList.add('hidden')">
        <p>TAP UNTUK TUTUP</p>
        <div id="myRoleTitle" class="role-title">???</div>
        <p id="myRoleDesc">...</p>
    </div>

    <div id="overlayWin" class="overlay hidden">
        <h1 id="winTitle" style="font-size: 4rem; color: var(--accent);">WIN!</h1>
        <p id="winDesc">Game Berakhir</p>
        <button onclick="location.reload()">MAIN LAGI</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove, onDisconnect, get } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9Q_Z8oewtWt6pphvwJQbh6PpAqyneYfM",
            authDomain: "werewolf-4d03a.firebaseapp.com",
            databaseURL: "https://werewolf-4d03a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "werewolf-4d03a",
            storageBucket: "werewolf-4d03a.firebasestorage.app",
            messagingSenderId: "989729672721",
            appId: "1:989729672721:web:bddba4f156ecca66c8abb0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= BANK SOAL (DISGUISED INPUT) =================

        // Tipe A: Pertanyaan Langsung (Ronde Ganjil)
        const singleQuestions = [
            "Siapa yang tatapan matanya paling mencurigakan?", "Siapa yang paling jago berbohong?",
            "Siapa yang terlihat paling gugup?", "Siapa yang senyumnya terlihat palsu?",
            "Siapa yang paling banyak diam?", "Siapa yang bicaranya paling berbelit-belit?",
            "Siapa yang paling mungkin jadi dalang?", "Siapa yang ekspresinya susah ditebak?",
            "Siapa yang paling menghindari kontak mata?", "Siapa yang paling ambisius menang?",
            "Jika ada zombie, siapa yang kamu korbankan?", "Siapa yang mati duluan di film horor?",
            "Siapa yang akan kamu ajak kerjasama di pulau?", "Siapa yang paling tega meninggalkan teman?",
            "Siapa yang outfit-nya paling keren?", "Siapa yang paling sering telat?",
            "Siapa yang wajahnya paling polos?", "Siapa yang paling sering drama?",
            "Pusatkan energimu. Siapa yang auranya gelap?", "Secara insting, siapa yang membuatmu tidak nyaman?",
            "Siapa yang terasa paling jauh darimu?", "Siapa yang memancarkan energi dominan?",
            "Siapa yang sulit kamu percaya 100%?", "Siapa yang punya rahasia terbesar?",
            "Siapa yang ingin kamu singkirkan dari meja?", "Kepada siapa intuisimu tertuju?"
        ];

        // Tipe B: Kuis Pilihan Ganda (Ronde Genap)
        const quizFillersQ1 = [
            "Perasaanmu malam ini?", "Elemen favoritmu?", "Pilih senjata:", 
            "Cuaca hatimu?", "Warna keberuntungan?", "Hewan jiwamu?", 
            "Jam tidurmu?", "Musik favorit?", "Satu kata sifat:", "Ketakutan terbesar?"
        ];
        
        const quizFillersQ2 = [
            ["Tenang", "Gelisah", "Waspada"], ["Api", "Air", "Angin"], ["Pisau", "Pistol", "Racun"],
            ["Badai", "Cerah", "Kabut"], ["Merah", "Hitam", "Putih"], ["Serigala", "Domba", "Ular"],
            ["9 Malam", "12 Malam", "Subuh"], ["Rock", "Jazz", "Pop"], ["Berani", "Licik", "Setia"],
            ["Gelap", "Tinggi", "Sepi"]
        ];

        const quizActionsQ3 = [
            "Siapa yang sedang kamu perhatikan?", "Tujukan nalurimu pada satu orang:",
            "Siapa yang nasibnya buruk malam ini?", "Kirim energi ke satu orang:",
            "Siapa yang ingin kamu kunjungi?", "Pilih satu nama dari daftar:",
            "Siapa yang paling mencolok?", "Tentukan targetmu sekarang:",
            "Siapa yang harus diperiksa?", "Kunci pandanganmu pada:"
        ];

        // --- FUNGSI GENERATOR KONTEN MALAM ---
        function getNightContent(round) {
            // Ganjil = Single, Genap = Quiz
            if (round % 2 !== 0) {
                const index = (round - 1) % singleQuestions.length;
                return { type: "SINGLE", text: singleQuestions[index] };
            } else {
                // Acak kuis
                const idx1 = (round + Math.floor(Math.random() * 5)) % quizFillersQ1.length;
                const idx3 = round % quizActionsQ3.length;
                return { 
                    type: "QUIZ", 
                    q1: quizFillersQ1[idx1], 
                    a1: quizFillersQ2[idx1], 
                    qText: quizActionsQ3[idx3] 
                };
            }
        }

        // --- GLOBAL STATE ---
        let myId = "u" + Math.floor(Math.random()*100000);
        let myName = "";
        let roomCode = "";
        let isHost = false;
        let myRole = "VILLAGER";
        let selectedTarget = null;
        let allPlayers = {};

        // ================= UI FUNCTIONS =================

        window.createRoom = () => {
            myName = document.getElementById("inputName").value.trim().toUpperCase();
            if(!myName) return alert("Isi nama dulu!");
            
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ";
            roomCode = "";
            for(let i=0; i<4; i++) roomCode += chars.charAt(Math.floor(Math.random()*chars.length));
            
            isHost = true;
            setupLobby();

            set(ref(db, `rooms/${roomCode}`), {
                status: "LOBBY",
                players: { [myId]: { name: myName, isHost: true } },
                gameState: { phase: "LOBBY" }
            });
            onDisconnect(ref(db, `rooms/${roomCode}`)).remove();
            listenRoom();
        };

        window.showJoin = () => {
            document.getElementById("viewLanding").classList.add("hidden");
            document.getElementById("viewJoin").classList.remove("hidden");
        }

        window.joinRoom = () => {
            myName = document.getElementById("inputName").value.trim().toUpperCase();
            roomCode = document.getElementById("inputCode").value.trim().toUpperCase();
            if(!myName || roomCode.length !== 4) return alert("Data tidak lengkap!");

            const rRef = ref(db, `rooms/${roomCode}`);
            get(rRef).then(snap => {
                if(snap.exists() && snap.val().status === "LOBBY") {
                    set(ref(db, `rooms/${roomCode}/players/${myId}`), { name: myName, isHost: false });
                    onDisconnect(ref(db, `rooms/${roomCode}/players/${myId}`)).remove();
                    setupLobby();
                    listenRoom();
                } else {
                    alert("Room tidak ditemukan atau sudah main!");
                }
            });
        };

        function setupLobby() {
            document.getElementById("viewLanding").classList.add("hidden");
            document.getElementById("viewJoin").classList.add("hidden");
            document.getElementById("viewWaiting").classList.remove("hidden");
            document.getElementById("dispCode").innerText = roomCode;
            if(isHost) {
                document.getElementById("hostPanel").classList.remove("hidden");
                document.getElementById("waitText").classList.add("hidden");
            }
        }

        // ================= GAME LOGIC =================

        function listenRoom() {
            onValue(ref(db, `rooms/${roomCode}/players`), snap => {
                allPlayers = snap.val() || {};
                document.getElementById("pCount").innerText = Object.keys(allPlayers).length;
                
                if(allPlayers[myId] && allPlayers[myId].privateMsg) {
                    const msgDiv = document.getElementById("privateMsg");
                    msgDiv.innerText = allPlayers[myId].privateMsg;
                    msgDiv.classList.remove("hidden");
                    setTimeout(() => { msgDiv.classList.add("hidden"); }, 8000);
                    if(!isHost) update(ref(db, `rooms/${roomCode}/players/${myId}`), { privateMsg: null });
                }
            });

            onValue(ref(db, `rooms/${roomCode}/gameState`), snap => {
                const state = snap.val();
                if(!state) return;

                if(state.phase === "STARTING") {
                    get(ref(db, `rooms/${roomCode}/players/${myId}/role`)).then(s => {
                        myRole = s.val();
                        updateRoleUI();
                        document.getElementById("screenLobby").classList.add("hidden");
                        document.getElementById("screenGame").classList.remove("hidden");
                        document.getElementById("overlayRole").classList.remove("hidden");
                    });
                } else if (state.phase === "GAME_OVER") {
                    document.getElementById("overlayWin").classList.remove("hidden");
                    document.getElementById("winTitle").innerText = state.winner + " MENANG!";
                } else {
                    renderGamePhase(state);
                }

                if(isHost) hostEngine(state);
            });
        }

        // --- RENDERER ---
        function renderGamePhase(state) {
            const body = document.body;
            const title = document.getElementById("phaseTitle");
            const descArea = document.getElementById("phaseDesc");
            const icon = document.getElementById("phaseIcon");
            const actionArea = document.getElementById("actionArea");
            const timer = document.getElementById("timerDisplay");

            timer.innerText = state.timer;
            actionArea.classList.add("hidden");
            document.getElementById("privateMsg").classList.add("hidden");

            switch(state.phase) {
                case "NIGHT":
                    body.style.background = "var(--bg-night)";
                    title.innerText = "MALAM HARI";
                    icon.innerText = "üåô";
                    
                    // --- LOGIKA BANK SOAL ---
                    const round = state.round || 1;
                    const content = getNightContent(round);
                    
                    if (content.type === "SINGLE") {
                        descArea.innerHTML = `<span style="color:#ffeb3b;">${content.text}</span>`;
                        actionArea.classList.remove("hidden");
                        renderGrid("NIGHT");
                        document.getElementById("btnAction").classList.remove("hidden");
                    } 
                    else if (content.type === "QUIZ") {
                        // Render Kuis Tahap 1
                        descArea.innerHTML = `
                            <div id="quizStep1">
                                <p style="color:#aaa; font-size:0.9rem;">PERTANYAAN 1/2</p>
                                <h3>${content.q1}</h3>
                                <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
                                    <button onclick="nextQuizStep('${content.qText}')" class="secondary" style="font-size:0.9rem;">${content.a1[0]}</button>
                                    <button onclick="nextQuizStep('${content.qText}')" class="secondary" style="font-size:0.9rem;">${content.a1[1]}</button>
                                    <button onclick="nextQuizStep('${content.qText}')" class="secondary" style="font-size:0.9rem;">${content.a1[2]}</button>
                                </div>
                            </div>
                        `;
                        // Sembunyikan Grid dulu
                        actionArea.classList.add("hidden");
                    }
                    break;

                case "DAY_ANNOUNCE":
                    body.style.background = "var(--bg-day)";
                    title.innerText = "PENGUMUMAN";
                    icon.innerText = "‚òÄÔ∏è";
                    descArea.innerText = state.announcement || "Desa aman terkendali.";
                    break;

                case "DAY_DISCUSS":
                    body.style.background = "var(--bg-day)";
                    title.innerText = "DISKUSI";
                    icon.innerText = "üó£Ô∏è";
                    descArea.innerText = "Waktunya debat! Cari pelakunya.";
                    break;

                case "VOTING":
                    body.style.background = "var(--bg-vote)";
                    title.innerText = "VOTING";
                    icon.innerText = "‚öñÔ∏è";
                    descArea.innerText = "Siapa yang akan digantung?";
                    actionArea.classList.remove("hidden");
                    renderGrid("VOTE");
                    document.getElementById("btnAction").classList.remove("hidden");
                    break;
            }
        }

        // Fungsi Transisi Kuis
        window.nextQuizStep = (qText) => {
            const descArea = document.getElementById("phaseDesc");
            const actionArea = document.getElementById("actionArea");
            
            descArea.innerHTML = `
                <div style="animation: popIn 0.3s;">
                    <p style="color:#aaa; font-size:0.9rem;">PERTANYAAN 2/2</p>
                    <h3 style="color:#ffeb3b;">${qText}</h3>
                </div>
            `;
            actionArea.classList.remove("hidden");
            renderGrid("NIGHT");
            document.getElementById("btnAction").classList.remove("hidden");
        }

        function renderGrid(mode) {
            const grid = document.getElementById("playerGrid");
            grid.innerHTML = "";
            
            Object.keys(allPlayers).forEach(key => {
                if(key === myId) return; 
                const p = allPlayers[key];
                
                const div = document.createElement("div");
                div.className = `p-card ${!p.isAlive ? 'dead' : ''}`;
                div.innerText = p.name;
                
                if(p.isAlive) {
                    div.onclick = () => {
                        document.querySelectorAll(".p-card").forEach(c => c.classList.remove("selected"));
                        div.classList.add("selected");
                        selectedTarget = key;
                    };
                }
                grid.appendChild(div);
            });
        }

        window.submitAction = () => {
            if(!selectedTarget) return alert("Pilih target dulu!");
            
            set(ref(db, `rooms/${roomCode}/actions/${myId}`), {
                target: selectedTarget,
                role: myRole
            });
            
            document.getElementById("actionArea").classList.add("hidden");
            document.getElementById("phaseDesc").innerText = "Jawaban tercatat. Menunggu yang lain...";
        }

        window.toggleRole = () => {
            document.getElementById("overlayRole").classList.remove("hidden");
        }

        function updateRoleUI() {
            document.getElementById("myRoleTitle").innerText = myRole;
            if(myRole === "WEREWOLF") {
                document.getElementById("myRoleDesc").innerText = "Tugas: Habisi semua warga. Pilih mangsa saat malam.";
                document.getElementById("myRoleTitle").style.color = "#e74c3c";
            } else if (myRole === "SEER") {
                document.getElementById("myRoleDesc").innerText = "Tugas: Cari Werewolf. Pilih pemain untuk diterawang saat malam.";
                document.getElementById("myRoleTitle").style.color = "#2ecc71";
            } else {
                document.getElementById("myRoleDesc").innerText = "Tugas: Bertahan hidup dan gantung Werewolf saat siang.";
            }
        }

        // ================= HOST LOGIC =================
        let lastTick = 0;

        window.startGame = () => {
            get(ref(db, `rooms/${roomCode}/players`)).then(snap => {
                const ids = Object.keys(snap.val());
                const count = ids.length;
                
                let wolves = count >= 8 ? 2 : 1;
                let seer = 1;
                let roles = [];
                for(let i=0; i<wolves; i++) roles.push("WEREWOLF");
                for(let i=0; i<seer; i++) roles.push("SEER");
                while(roles.length < count) roles.push("VILLAGER");
                
                roles.sort(() => Math.random() - 0.5);

                ids.forEach((id, idx) => {
                    update(ref(db, `rooms/${roomCode}/players/${id}`), { 
                        role: roles[idx], isAlive: true, privateMsg: null 
                    });
                });

                update(ref(db, `rooms/${roomCode}`), { status: "PLAYING" });
                update(ref(db, `rooms/${roomCode}/gameState`), { phase: "STARTING", timer: 5, round: 1 });
            });
        }

        function hostEngine(state) {
            const now = Date.now();
            if(now - lastTick < 1000) return;
            lastTick = now;

            if(state.timer > 0) {
                update(ref(db, `rooms/${roomCode}/gameState/timer`), state.timer - 1);
            } else {
                let next = "";
                let time = 0;
                let announce = "";
                let nextRound = state.round || 1;

                if(state.phase === "STARTING") {
                    next = "NIGHT"; time = 20;
                    remove(ref(db, `rooms/${roomCode}/actions`));
                }
                else if(state.phase === "NIGHT") {
                    processNightActions().then(resultText => {
                        update(ref(db, `rooms/${roomCode}/gameState`), {
                            phase: "DAY_ANNOUNCE",
                            timer: 8,
                            announcement: resultText,
                            round: nextRound
                        });
                        checkWinCondition();
                    });
                    return;
                }
                else if(state.phase === "DAY_ANNOUNCE") {
                    next = "DAY_DISCUSS"; time = 60;
                }
                else if(state.phase === "DAY_DISCUSS") {
                    next = "VOTING"; time = 20;
                    remove(ref(db, `rooms/${roomCode}/actions`));
                }
                else if(state.phase === "VOTING") {
                    processVoting().then(resultText => {
                        update(ref(db, `rooms/${roomCode}/gameState`), {
                            phase: "DAY_ANNOUNCE",
                            timer: 8,
                            announcement: resultText,
                            round: nextRound
                        });
                        checkWinCondition();
                    });
                    
                    setTimeout(() => {
                         update(ref(db, `rooms/${roomCode}/gameState`), { 
                             phase: "NIGHT", 
                             timer: 20,
                             round: nextRound + 1 // RONDE NAIK
                         });
                         remove(ref(db, `rooms/${roomCode}/actions`));
                    }, 8000);
                    return;
                }

                if(next) {
                    update(ref(db, `rooms/${roomCode}/gameState`), { 
                        phase: next, timer: time, announcement: announce, round: nextRound 
                    });
                }
            }
        }

        async function processNightActions() {
            const snap = await get(ref(db, `rooms/${roomCode}/actions`));
            const actions = snap.val() || {};
            
            let wolfVotes = {};
            let seerTarget = null;
            let seerId = null;

            Object.keys(actions).forEach(uid => {
                const act = actions[uid];
                if(act.role === "WEREWOLF") wolfVotes[act.target] = (wolfVotes[act.target] || 0) + 1;
                if(act.role === "SEER") { seerTarget = act.target; seerId = uid; }
            });

            let victim = null;
            let maxV = 0;
            Object.keys(wolfVotes).forEach(target => {
                if(wolfVotes[target] > maxV) { maxV = wolfVotes[target]; victim = target; }
            });

            let text = "Malam yang tenang. Tidak ada yang mati.";
            if(victim) {
                update(ref(db, `rooms/${roomCode}/players/${victim}`), { isAlive: false });
                const vName = allPlayers[victim].name;
                text = `Malam berdarah! ${vName} ditemukan tewas.`;
            }

            if(seerTarget && seerId) {
                const targetRole = allPlayers[seerTarget].role;
                const isBad = (targetRole === "WEREWOLF");
                const msg = `Penerawanganmu: ${allPlayers[seerTarget].name} adalah ${isBad ? "WEREWOLF!" : "Warga."}`;
                update(ref(db, `rooms/${roomCode}/players/${seerId}`), { privateMsg: msg });
            }
            return text;
        }

        async function processVoting() {
            const snap = await get(ref(db, `rooms/${roomCode}/actions`));
            const votes = snap.val() || {};
            
            let counts = {};
            Object.values(votes).forEach(v => counts[v.target] = (counts[v.target] || 0) + 1);

            let executed = null;
            let maxV = 0;
            Object.keys(counts).forEach(target => {
                if(counts[target] > maxV) { maxV = counts[target]; executed = target; }
            });

            if(executed && maxV >= 2) {
                update(ref(db, `rooms/${roomCode}/players/${executed}`), { isAlive: false });
                return `Warga sepakat! ${allPlayers[executed].name} dieksekusi.`;
            } else {
                return "Voting seri/kurang. Tidak ada eksekusi.";
            }
        }

        function checkWinCondition() {
            get(ref(db, `rooms/${roomCode}/players`)).then(snap => {
                const ps = snap.val();
                let wolves = 0;
                let villagers = 0;
                Object.values(ps).forEach(p => {
                    if(p.isAlive) {
                        if(p.role === "WEREWOLF") wolves++; else villagers++;
                    }
                });
                if(wolves === 0) update(ref(db, `rooms/${roomCode}/gameState`), { phase: "GAME_OVER", winner: "VILLAGERS" });
                else if (wolves >= villagers) update(ref(db, `rooms/${roomCode}/gameState`), { phase: "GAME_OVER", winner: "WEREWOLVES" });
            });
        }
    </script>
</body>
</html>