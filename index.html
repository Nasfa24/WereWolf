<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <title>Werewolf Phygital v8.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" rel="stylesheet">

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-dark: #16213e;
            --bg-night: #0f3460;
            --bg-day: #3282b8;
            --bg-vote: #e94560;
            --accent: #ffd369;
            --text-main: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            height: 100dvh; /* Dynamic Viewport Height untuk Mobile */
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.6s ease;
            overflow: hidden;
            user-select: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .screen { 
            width: 100%; max-width: 450px; height: 100%; 
            display: flex; flex-direction: column; 
            padding: 20px; text-align: center; justify-content: center;
            position: relative;
        }

        /* TYPOGRAPHY */
        h1 { font-size: 2rem; font-weight: 800; margin: 0 0 10px 0; letter-spacing: 1px; line-height: 1.1; }
        h2 { font-size: 3rem; margin: 10px 0; color: var(--accent); background: rgba(0,0,0,0.2); padding: 5px 25px; border-radius: 20px; display: inline-block; }
        p { opacity: 0.9; margin-bottom: 15px; font-weight: 400; }

        /* ICON STYLING */
        .material-symbols-rounded {
            font-size: 4rem; margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .small-icon { font-size: 1.2rem; vertical-align: middle; margin-right: 5px; }

        /* INPUTS & BUTTONS */
        input { 
            padding: 18px; width: 100%; font-size: 1.1rem; 
            border-radius: 15px; border: 2px solid rgba(255,255,255,0.2); 
            background: rgba(0,0,0,0.2); color: white;
            text-align: center; margin-bottom: 15px; font-family: inherit;
            outline: none; transition: border 0.3s;
        }
        input:focus { border-color: var(--accent); }

        button { 
            background: var(--text-main); color: var(--bg-dark); 
            border: none; padding: 18px; font-size: 1.1rem; font-weight: 800; 
            border-radius: 15px; cursor: pointer; width: 100%; 
            margin-bottom: 12px; box-shadow: 0 5px 0 rgba(0,0,0,0.2); 
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        
        button.secondary { background: rgba(255,255,255,0.15); color: white; box-shadow: none; border: 1px solid rgba(255,255,255,0.2); }
        button.emergency { background: #e74c3c; color: white; font-size: 0.8rem; padding: 10px; width: auto; margin: 20px auto 0; border: 1px solid white; display: inline-block;}

        /* GAME ELEMENTS */
        .timer-display { 
            font-size: 5rem; font-weight: 800; margin-top: auto; 
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2); 
            font-variant-numeric: tabular-nums;
        }
        
        #phaseDesc {
            background: rgba(0, 0, 0, 0.25);
            padding: 20px; border-radius: 15px;
            margin: 10px 0; font-size: 1.1rem; line-height: 1.5;
            border-left: 5px solid var(--accent);
            text-align: left;
        }

        /* PLAYER GRID (Cards) */
        .player-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            width: 100%; max-height: 45vh; overflow-y: auto; margin: 10px 0;
            padding-bottom: 50px; /* Space for button */
        }
        .p-card { 
            background: var(--card-bg); padding: 20px 10px; border-radius: 12px; 
            cursor: pointer; border: 2px solid transparent; font-weight: 600;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .p-card.selected { 
            background: var(--accent); color: var(--bg-dark); 
            border-color: white; transform: scale(1.02); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .p-card.dead { opacity: 0.5; filter: grayscale(1); background: #000; }

        /* FLOATING ROLE BUTTON */
        .fab-role {
            position: absolute; top: 15px; left: 15px;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            color: white; border-radius: 30px; padding: 8px 16px;
            font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 5px; z-index: 10;
            cursor: pointer;
        }

        /* OVERLAYS & TOASTS */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 40px; animation: fadeIn 0.3s;
        }
        .role-reveal-box {
            border: 2px solid var(--accent); padding: 30px; border-radius: 20px;
            background: radial-gradient(circle, #2c3e50 0%, #000 100%);
            box-shadow: 0 0 30px var(--accent);
        }
        
        .msg-toast { 
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: #000; padding: 12px 20px; 
            border-radius: 50px; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 20;
            width: 90%; max-width: 350px; animation: slideDown 0.5s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { top: -50px; } to { top: 70px; } }
    </style>
</head>
<body>

    <div id="debugStatus" style="position:fixed; bottom:5px; left:5px; font-size:0.6rem; opacity:0.3;">v8.0 Ready</div>

    <div id="screenLobby" class="screen">
        <div id="viewLanding">
            <span class="material-symbols-rounded" style="color:var(--accent); font-size: 5rem;">pets</span>
            <h1>WEREWOLF<br>PHYGITAL</h1>
            <p style="font-size: 0.9rem; margin-top: -5px;">Mobile App Experience</p>
            <br>
            
            <div id="rejoinPanel" class="hidden" style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; margin-bottom:20px;">
                <p style="margin:0; font-size:0.8rem;">Sesi ditemukan:</p>
                <h3 id="lastSessionInfo" style="margin:5px 0 15px 0; color:white;">ROOM</h3>
                <button onclick="rejoinGame()" style="background:var(--accent); color:black;">
                    <span class="material-symbols-rounded small-icon">play_arrow</span> LANJUTKAN
                </button>
            </div>

            <input type="text" id="inputName" placeholder="NAMA KAMU">
            <button onclick="createRoom()">
                <span class="material-symbols-rounded small-icon">add_circle</span> BUAT ROOM
            </button>
            <button class="secondary" onclick="showJoin()">
                <span class="material-symbols-rounded small-icon">login</span> GABUNG
            </button>
        </div>

        <div id="viewJoin" class="hidden">
            <h1>GABUNG</h1>
            <p>Minta 4 Huruf Kode ke Host</p>
            <input type="text" id="inputCode" placeholder="KODE (CONTOH: ABCD)" maxlength="4" style="text-transform:uppercase; letter-spacing: 5px; font-size: 1.5rem;">
            <button onclick="joinRoom()">MASUK ROOM</button>
            <button class="secondary" onclick="location.reload()">BATAL</button>
        </div>

        <div id="viewWaiting" class="hidden">
            <p>KODE ROOM</p>
            <h2><span id="dispCode">----</span></h2>
            <div style="margin: 20px 0;">
                <span class="material-symbols-rounded" style="font-size: 2rem;">group</span>
                <p style="margin:0;"><span id="pCount">0</span> Pemain Masuk</p>
            </div>
            
            <div id="hostPanel" class="hidden">
                <button onclick="startGame()" style="background:var(--accent); color:black;">
                    <span class="material-symbols-rounded small-icon">play_circle</span> MULAI GAME
                </button>
            </div>
            <p id="waitText" style="opacity:0.6; font-size:0.9rem;">Menunggu Host memulai...</p>
        </div>
    </div>

    <div id="screenGame" class="screen hidden">
        <div class="fab-role" onclick="toggleRole()">
            <span class="material-symbols-rounded" style="font-size:1.2rem">visibility</span> PERAN
        </div>

        <div id="privateMsg" class="msg-toast hidden"></div>

        <div style="margin-top: 50px;">
            <span id="phaseIcon" class="material-symbols-rounded">hourglass_empty</span>
            <h1 id="phaseTitle">LOADING</h1>
        </div>

        <div id="phaseDesc">Menghubungkan ke server...</div>
        
        <div id="actionArea" class="hidden" style="flex-grow:1; display:flex; flex-direction:column;">
            <div id="playerGrid" class="player-grid"></div>
            <button id="btnAction" onclick="submitAction()" style="margin-top:auto; background:var(--accent); color:black;">
                <span class="material-symbols-rounded small-icon">check_circle</span> KONFIRMASI
            </button>
        </div>

        <div id="timerDisplay" class="timer-display"></div>

        <button id="btnForceNext" class="emergency hidden" onclick="forceNextPhase()">
            <span class="material-symbols-rounded small-icon">skip_next</span> SKIP FASE
        </button>
    </div>

    <div id="overlayRole" class="overlay hidden" onclick="this.classList.add('hidden')">
        <div class="role-reveal-box">
            <p style="color:#aaa; margin:0;">PERAN KAMU</p>
            <h1 id="myRoleTitle" style="font-size: 3rem; margin: 10px 0; color:var(--accent);">???</h1>
            <p id="myRoleDesc">Ketuk untuk menutup</p>
        </div>
    </div>

    <div id="overlayWin" class="overlay hidden">
        <span class="material-symbols-rounded" style="font-size: 5rem; color:var(--accent);">emoji_events</span>
        <h1 id="winTitle" style="font-size: 3rem; margin:10px 0;">WINNER</h1>
        <p>Permainan Selesai</p>
        <button onclick="location.reload()" style="width:auto; padding: 15px 40px;">MAIN LAGI</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove, onDisconnect, get } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // CONFIG (GUNAKAN MILIKMU)
        const firebaseConfig = {
            apiKey: "AIzaSyB9Q_Z8oewtWt6pphvwJQbh6PpAqyneYfM",
            authDomain: "werewolf-4d03a.firebaseapp.com",
            databaseURL: "https://werewolf-4d03a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "werewolf-4d03a",
            storageBucket: "werewolf-4d03a.firebasestorage.app",
            messagingSenderId: "989729672721",
            appId: "1:989729672721:web:bddba4f156ecca66c8abb0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ASSETS: BANK SOAL & IKON ---
        const singleQuestions = [
            "Siapa yang tatapan matanya paling mencurigakan?", "Siapa yang paling jago berbohong?",
            "Siapa yang terlihat paling gugup?", "Siapa yang senyumnya terlihat palsu?",
            "Siapa yang paling banyak diam?", "Siapa yang bicaranya paling berbelit-belit?",
            "Siapa yang paling mungkin jadi dalang?", "Siapa yang ekspresinya susah ditebak?",
            "Siapa yang paling menghindari kontak mata?", "Siapa yang paling ambisius menang?",
            "Jika ada zombie, siapa yang kamu korbankan?", "Siapa yang mati duluan di film horor?",
            "Siapa yang akan kamu ajak kerjasama di pulau?", "Siapa yang paling tega meninggalkan teman?",
            "Siapa yang outfit-nya paling keren?", "Siapa yang paling sering telat?",
            "Siapa yang wajahnya paling polos?", "Siapa yang paling sering drama?",
            "Pusatkan energimu. Siapa yang auranya gelap?", "Secara insting, siapa yang membuatmu tidak nyaman?",
            "Siapa yang terasa paling jauh darimu?", "Siapa yang memancarkan energi dominan?",
            "Siapa yang sulit kamu percaya 100%?", "Siapa yang punya rahasia terbesar?",
            "Siapa yang ingin kamu singkirkan dari meja?", "Kepada siapa intuisimu tertuju?"
        ];
        
        // ICONS MAPPING
        const PHASE_ICONS = {
            "STARTING": "hourglass_top",
            "NIGHT": "bedtime", // Ikon Bulan
            "DAY_ANNOUNCE": "wb_sunny", // Ikon Matahari
            "DAY_DISCUSS": "forum", // Ikon Diskusi
            "VOTING": "how_to_vote", // Ikon Vote
            "GAME_OVER": "emoji_events"
        };

        const PHASE_COLORS = {
            "STARTING": "#2c3e50",
            "NIGHT": "#0f3460", // Dark Blue
            "DAY_ANNOUNCE": "#f1c40f", // Yellow
            "DAY_DISCUSS": "#3282b8", // Light Blue
            "VOTING": "#e94560" // Red
        };

        function getNightContent(round) {
            // Logika Stabil: Selalu sama untuk ronde yang sama
            const index = (round - 1) % singleQuestions.length;
            return { type: "SINGLE", text: singleQuestions[index] };
        }

        // --- STATE ---
        let myId = "u" + Math.floor(Math.random()*100000);
        let myName = "", roomCode = "", isHost = false, myRole = "VILLAGER";
        let selectedTarget = null, allPlayers = {}, roleFetched = false;
        let hostLocalTimer = 0, lastRenderedPhase = "";

        // --- RECONNECT CHECK ---
        setTimeout(() => {
            const savedRoom = localStorage.getItem("ww_room");
            const savedName = localStorage.getItem("ww_name");
            if (savedRoom && savedName) {
                document.getElementById("rejoinPanel").classList.remove("hidden");
                document.getElementById("lastSessionInfo").innerText = `${savedRoom} (${savedName})`;
            }
        }, 500);

        window.rejoinGame = () => {
            roomCode = localStorage.getItem("ww_room");
            myName = localStorage.getItem("ww_name");
            myId = localStorage.getItem("ww_id") || myId;
            isHost = (localStorage.getItem("ww_host") === "true");
            setupLobby();
            listenRoom();
        }
        
        window.clearSession = () => { localStorage.clear(); location.reload(); }

        // --- NAVIGATION ---
        window.createRoom = () => {
            myName = document.getElementById("inputName").value.trim().toUpperCase();
            if(!myName) return alert("Isi nama dulu!");
            roomCode = generateCode(); isHost = true;
            saveSession(); setupLobby();
            
            set(ref(db, `rooms/${roomCode}`), {
                status: "LOBBY",
                players: { [myId]: { name: myName, isHost: true } },
                gameState: { phase: "LOBBY" }
            });
            onDisconnect(ref(db, `rooms/${roomCode}`)).remove();
            listenRoom();
        };

        window.showJoin = () => {
            if(!document.getElementById("inputName").value.trim()) return alert("Isi nama dulu!");
            document.getElementById("viewLanding").classList.add("hidden");
            document.getElementById("viewJoin").classList.remove("hidden");
        }

        window.joinRoom = () => {
            myName = document.getElementById("inputName").value.trim().toUpperCase();
            roomCode = document.getElementById("inputCode").value.trim().toUpperCase();
            if(roomCode.length !== 4) return alert("Kode harus 4 huruf!");

            get(ref(db, `rooms/${roomCode}`)).then(snap => {
                if(snap.exists() && snap.val().status === "LOBBY") {
                    set(ref(db, `rooms/${roomCode}/players/${myId}`), { name: myName, isHost: false });
                    onDisconnect(ref(db, `rooms/${roomCode}/players/${myId}`)).remove();
                    isHost = false; saveSession(); setupLobby(); listenRoom();
                } else { alert("Room tidak ditemukan/sudah main!"); }
            });
        };

        function generateCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ";
            let res = ""; for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
            return res;
        }

        function saveSession() {
            localStorage.setItem("ww_room", roomCode);
            localStorage.setItem("ww_name", myName);
            localStorage.setItem("ww_id", myId);
            localStorage.setItem("ww_host", isHost);
        }

        function setupLobby() {
            document.getElementById("viewLanding").classList.add("hidden");
            document.getElementById("viewJoin").classList.add("hidden");
            document.getElementById("viewWaiting").classList.remove("hidden");
            document.getElementById("dispCode").innerText = roomCode;
            if(isHost) document.getElementById("hostPanel").classList.remove("hidden");
        }

        // --- CORE LISTENER ---
        function listenRoom() {
            onValue(ref(db, `rooms/${roomCode}/players`), snap => {
                allPlayers = snap.val() || {};
                document.getElementById("pCount").innerText = Object.keys(allPlayers).length;
                
                if (allPlayers[myId]?.isHost) {
                    isHost = true;
                    document.getElementById("btnForceNext").classList.remove("hidden");
                    if (!window.hostInterval) startHostEngine();
                }

                if (allPlayers[myId]?.privateMsg) {
                    const el = document.getElementById("privateMsg");
                    el.innerHTML = `<span class="material-symbols-rounded small-icon">info</span> ${allPlayers[myId].privateMsg}`;
                    el.classList.remove("hidden");
                    setTimeout(() => el.classList.add("hidden"), 8000);
                    if(!isHost) update(ref(db, `rooms/${roomCode}/players/${myId}`), { privateMsg: null });
                }
            });

            onValue(ref(db, `rooms/${roomCode}/gameState`), snap => {
                const state = snap.val();
                if(!state) return;

                if (isHost) {
                    // Sync timer lokal jika beda jauh (reconnect)
                    if (Math.abs(hostLocalTimer - state.timer) > 3) hostLocalTimer = state.timer;
                }

                if (state.phase === "GAME_OVER") {
                    document.getElementById("overlayWin").classList.remove("hidden");
                    document.getElementById("winTitle").innerText = state.winner;
                    if(isHost) clearInterval(window.hostInterval);
                } else {
                    renderGamePhase(state);
                }
            });
        }

        function renderGamePhase(state) {
            // 1. UPDATE TIMER (Ringan)
            document.getElementById("timerDisplay").innerText = (state.timer !== undefined) ? state.timer : "";

            // 2. CEK PERUBAHAN FASE (Berat)
            if (lastRenderedPhase === state.phase) return; 
            lastRenderedPhase = state.phase;

            // Transisi Layar
            if (state.phase !== "LOBBY") {
                document.getElementById("screenLobby").classList.add("hidden");
                document.getElementById("screenGame").classList.remove("hidden");
            }

            // Ambil Peran Sekali
            if (state.phase === "STARTING" && !roleFetched) {
                get(ref(db, `rooms/${roomCode}/players/${myId}/role`)).then(s => {
                    myRole = s.val();
                    updateRoleUI();
                    document.getElementById("overlayRole").classList.remove("hidden");
                    roleFetched = true;
                });
            }

            // GANTI WARNA & IKON
            document.body.style.backgroundColor = PHASE_COLORS[state.phase] || "#2c3e50";
            if(state.phase === "DAY_ANNOUNCE") document.body.style.color = "#000"; // Text hitam kalau kuning
            else document.body.style.color = "#fff";

            document.getElementById("phaseIcon").innerText = PHASE_ICONS[state.phase] || "help";
            
            // RESET UI
            const title = document.getElementById("phaseTitle");
            const desc = document.getElementById("phaseDesc");
            const action = document.getElementById("actionArea");
            action.classList.add("hidden");

            switch(state.phase) {
                case "STARTING":
                    title.innerText = "GAME DIMULAI";
                    desc.innerText = "Siap-siap, peran akan dibagikan...";
                    break;

                case "NIGHT":
                    title.innerText = "MALAM HARI";
                    const round = state.round || 1;
                    const content = getNightContent(round);
                    desc.innerHTML = `<b>Pertanyaan #${round}:</b><br>${content.text}`;
                    action.classList.remove("hidden");
                    renderGrid();
                    break;

                case "DAY_ANNOUNCE":
                    title.innerText = "PENGUMUMAN";
                    desc.innerText = state.announcement || "Desa aman.";
                    break;

                case "DAY_DISCUSS":
                    title.innerText = "DISKUSI";
                    desc.innerText = "Waktu berdebat! Cari siapa pelakunya.";
                    break;

                case "VOTING":
                    title.innerText = "VOTING";
                    desc.innerText = "Pilih pemain untuk dieksekusi.";
                    action.classList.remove("hidden");
                    renderGrid();
                    break;
            }
        }

        function renderGrid() {
            const grid = document.getElementById("playerGrid");
            grid.innerHTML = "";
            Object.keys(allPlayers).forEach(key => {
                if(key === myId) return; 
                const p = allPlayers[key];
                const div = document.createElement("div");
                div.className = `p-card ${!p.isAlive ? 'dead' : ''}`;
                div.innerHTML = `<span class="material-symbols-rounded small-icon">person</span> ${p.name}`;
                if(p.isAlive) {
                    div.onclick = () => {
                        document.querySelectorAll(".p-card").forEach(c => c.classList.remove("selected"));
                        div.classList.add("selected");
                        selectedTarget = key;
                        if(navigator.vibrate) navigator.vibrate(50);
                    };
                }
                grid.appendChild(div);
            });
        }

        window.submitAction = () => {
            if(!selectedTarget) return alert("Pilih satu pemain!");
            set(ref(db, `rooms/${roomCode}/actions/${myId}`), { target: selectedTarget, role: myRole });
            document.getElementById("actionArea").classList.add("hidden");
            document.getElementById("phaseDesc").innerHTML = "<span style='color:#2ecc71'>âœ… Jawaban Terkirim</span><br>Menunggu pemain lain...";
        }

        window.toggleRole = () => document.getElementById("overlayRole").classList.remove("hidden");
        
        function updateRoleUI() {
            document.getElementById("myRoleTitle").innerText = myRole;
            let desc = "Warga biasa. Cari Wolf.";
            let color = "#2ecc71";
            
            if(myRole === "WEREWOLF") { desc = "Mangsa warga tiap malam."; color = "#e74c3c"; }
            if(myRole === "SEER") { desc = "Terawang peran pemain lain."; color = "#3498db"; }
            
            document.getElementById("myRoleDesc").innerText = desc;
            document.getElementById("myRoleTitle").style.color = color;
        }

        // ================= HOST LOGIC =================
        let processing = false;

        window.startGame = () => {
            get(ref(db, `rooms/${roomCode}/players`)).then(snap => {
                const ids = Object.keys(snap.val());
                // Distribusi Role
                let roles = Array(ids.length).fill("VILLAGER");
                let wolves = ids.length >= 8 ? 2 : 1;
                let seer = 1;
                
                for(let i=0; i<wolves; i++) roles[i] = "WEREWOLF";
                for(let i=wolves; i<wolves+seer; i++) roles[i] = "SEER";
                roles.sort(() => Math.random() - 0.5);

                ids.forEach((id, i) => update(ref(db, `rooms/${roomCode}/players/${id}`), { role: roles[i], isAlive: true }));
                
                update(ref(db, `rooms/${roomCode}`), { status: "PLAYING" });
                hostLocalTimer = 5;
                update(ref(db, `rooms/${roomCode}/gameState`), { phase: "STARTING", timer: 5, round: 1 });
                startHostEngine();
            });
        }

        function startHostEngine() {
            if (window.hostInterval) clearInterval(window.hostInterval);
            window.hostInterval = setInterval(hostLoop, 1000);
        }

        window.forceNextPhase = () => { hostLocalTimer = 0; processing = false; hostLoop(); }

        function hostLoop() {
            if (!isHost) return;
            if (hostLocalTimer > 0) {
                hostLocalTimer--;
                set(ref(db, `rooms/${roomCode}/gameState/timer`), hostLocalTimer);
                processing = false;
            } else {
                if (processing) return;
                processing = true;
                
                get(ref(db, `rooms/${roomCode}/gameState`)).then(snap => {
                    let s = snap.val();
                    let next = "", time = 0, txt = "", r = s.round || 1;

                    // DURASI WAKTU
                    if(s.phase === "STARTING") { next="NIGHT"; time=60; remove(ref(db, `rooms/${roomCode}/actions`)); }
                    else if(s.phase === "NIGHT") {
                        processNight().then(res => {
                            hostLocalTimer = 10;
                            update(ref(db, `rooms/${roomCode}/gameState`), { phase:"DAY_ANNOUNCE", timer:10, announcement:res, round:r });
                            checkWin();
                        }); return;
                    }
                    else if(s.phase === "DAY_ANNOUNCE") { next="DAY_DISCUSS"; time=180; }
                    else if(s.phase === "DAY_DISCUSS") { next="VOTING"; time=30; remove(ref(db, `rooms/${roomCode}/actions`)); }
                    else if(s.phase === "VOTING") {
                        processVote().then(res => {
                            hostLocalTimer = 10;
                            update(ref(db, `rooms/${roomCode}/gameState`), { phase:"DAY_ANNOUNCE", timer:10, announcement:res, round:r });
                            checkWin();
                        });
                        setTimeout(() => {
                            hostLocalTimer = 60;
                            update(ref(db, `rooms/${roomCode}/gameState`), { phase:"NIGHT", timer:60, round: r+1 });
                            remove(ref(db, `rooms/${roomCode}/actions`));
                        }, 10000); return;
                    }

                    if(next) {
                        hostLocalTimer = time;
                        update(ref(db, `rooms/${roomCode}/gameState`), { phase:next, timer:time, announcement:txt, round:r });
                    }
                });
            }
        }

        async function processNight() {
            const snap = await get(ref(db, `rooms/${roomCode}/actions`));
            const acts = snap.val() || {};
            let votes = {}, seerT = null, seerId = null;
            
            Object.keys(acts).forEach(k => {
                if(acts[k].role === "WEREWOLF") votes[acts[k].target] = (votes[acts[k].target]||0)+1;
                if(acts[k].role === "SEER") { seerT = acts[k].target; seerId = k; }
            });

            // Kill Logic
            let victim = null, max = 0;
            Object.keys(votes).forEach(k => { if(votes[k] > max){ max = votes[k]; victim = k; }});
            
            let msg = "Malam tenang. Tidak ada korban.";
            if(victim) {
                update(ref(db, `rooms/${roomCode}/players/${victim}`), { isAlive: false });
                msg = `Malam berdarah! ${allPlayers[victim].name} tewas.`;
            }

            // Seer Logic
            if(seerT && seerId) {
                const isWolf = (allPlayers[seerT].role === "WEREWOLF");
                const info = `Hasil Terawangan: ${allPlayers[seerT].name} adalah ${isWolf ? "WEREWOLF!" : "WARGA."}`;
                update(ref(db, `rooms/${roomCode}/players/${seerId}`), { privateMsg: info });
            }
            return msg;
        }

        async function processVote() {
            const snap = await get(ref(db, `rooms/${roomCode}/actions`));
            const acts = snap.val() || {};
            let votes = {}, victim = null, max = 0;
            
            Object.values(acts).forEach(v => votes[v.target] = (votes[v.target]||0)+1);
            Object.keys(votes).forEach(k => { if(votes[k] > max){ max = votes[k]; victim = k; }});

            if(victim && max >= 2) {
                update(ref(db, `rooms/${roomCode}/players/${victim}`), { isAlive: false });
                return `Warga sepakat! ${allPlayers[victim].name} dieksekusi.`;
            }
            return "Voting seri/kurang. Tidak ada eksekusi.";
        }

        function checkWin() {
            get(ref(db, `rooms/${roomCode}/players`)).then(s => {
                let w=0, v=0;
                Object.values(s.val()).forEach(p => { if(p.isAlive) p.role==="WEREWOLF" ? w++ : v++; });
                if(w===0) update(ref(db, `rooms/${roomCode}/gameState`), { phase:"GAME_OVER", winner:"VILLAGERS" });
                else if(w>=v) update(ref(db, `rooms/${roomCode}/gameState`), { phase:"GAME_OVER", winner:"WEREWOLVES" });
            });
        }
    </script>
</body>
</html>