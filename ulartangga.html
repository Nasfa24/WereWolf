<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M75 10 L40 40 L25 50 L40 60 L75 90 L55 50 Z' stroke='%2300FF9D' stroke-width='4' fill='%23121212'/><circle cx='40' cy='50' r='5' fill='%23ff4757'/></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUNA: Geometry War (Pro)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00FF9D;
            --secondary: #0066FF;
            --accent: #9D00FF;
            --danger: #ff4757;
            --bg-dark: #121212;
            --panel-bg: #1E1E2E;
            --text-light: #FFFFFF;
        }

        body { 
            font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text-light); 
            text-align: center; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding-bottom: 20px; overflow-x: hidden;
        }

        .container { 
            background: var(--panel-bg); padding: 25px 20px; 
            border-bottom: 4px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0, 255, 157, 0.1); width: 100%; max-width: 500px; 
            box-sizing: border-box; border-radius: 0 0 25px 25px; position: relative; z-index: 5;
        }

        h1 { margin: 5px 0; color: var(--primary); font-size: 2.2rem; font-weight: 800; text-transform: uppercase; text-shadow: 0 0 15px rgba(0, 255, 157, 0.4); letter-spacing: 2px; }
        
        /* INPUT & BUTTONS */
        input { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: 2px solid #2f3640; font-size: 16px; background: #0f0f0f; color: white; text-align: center; font-weight: bold; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--primary); background: #2f3640; }
        
        button { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: none; font-size: 16px; cursor: pointer; font-weight: 700; text-transform: uppercase; transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.3); font-family: 'Poppins', sans-serif; }
        button:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-green { background: var(--primary); color: #000; box-shadow: 0 4px 0 #00b894; }
        .btn-blue { background: var(--secondary); color: white; box-shadow: 0 4px 0 #0044bd; }
        .btn-purple { background: var(--accent); color: white; box-shadow: 0 4px 0 #7000bd; }
        .btn-red { background: var(--danger); color: white; box-shadow: 0 4px 0 #bd0015; }
        .btn-disabled { background: #57606f; color: #a4b0be; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        .hidden { display: none !important; }

        /* GAME BOARD AREA */
        #game-board-area { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; 
            background: #2f3542; padding: 5px; border-radius: 8px; margin-bottom: 20px; 
            position: relative; aspect-ratio: 1 / 1; border: 2px solid #57606f; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .tile { 
            background: #353b48; color: rgba(255, 255, 255, 0.3); display: flex; justify-content: center; align-items: center; 
            font-size: 9px; border-radius: 3px; font-weight: bold; user-select: none;
        }
        .tile.ladder { background: #00b894; color: white; border: 1px solid #55efc4; }
        .tile.snake { background: #d63031; color: white; border: 1px solid #ff7675; }
        .tile.mystery { background: #6c5ce7; color: white; font-size: 14px; border: 1px solid #a29bfe; }
        .tile.trap { background: #000; border: 2px solid red; color: red; }
        #tile-100 { background: #fdcb6e; color: #d35400; border: 2px solid white; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* --- TOKEN SYSTEM (NEW: SMOOTH MOVEMENT) --- */
        #token-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Supaya klik tembus ke board */
            z-index: 10;
        }

        .token { 
            width: 8%; height: 8%; /* Ukuran relatif terhadap board */
            position: absolute; 
            display: flex; justify-content: center; align-items: center;
            font-size: 14px; color: white; 
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.8));
            transition: top 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: top, left;
            z-index: 20;
        }
        
        .shape-circle { border-radius: 50%; border: 2px solid white; }
        .shape-square { border-radius: 4px; border: 2px solid white; }
        .token.active-turn { z-index: 30; transform: scale(1.3); filter: drop-shadow(0 0 8px white); }

        /* --- VISUAL DICE SYSTEM --- */
        #dice-container {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0; perspective: 400px;
        }
        .dice {
            width: 50px; height: 50px; background: white; border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2), 0 4px 0 #ccc;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: bold; color: #2d3436;
            border: 2px solid #dfe6e9;
        }
        .dice.shaking { animation: shake 0.5s infinite; background: #ffeaa7; }
        
        @keyframes shake {
            0% { transform: rotate(0deg) translate(0,0); }
            25% { transform: rotate(10deg) translate(2px, 2px); }
            50% { transform: rotate(-10deg) translate(-2px, -2px); }
            75% { transform: rotate(5deg) translate(0, 5px); }
            100% { transform: rotate(0deg) translate(0,0); }
        }

        /* --- INVENTORY & UI --- */
        #inventory-area { 
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; height: 160px; 
            display: flex; gap: 10px; overflow-x: auto; align-items: center; border: 1px solid #57606f; 
        }
        .card-item { 
            min-width: 90px; height: 130px; background: #2f3542; color: white; border-radius: 10px; 
            border-bottom: 5px solid #57606f; display: flex; flex-direction: column; justify-content: center; 
            align-items: center; padding: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: center; 
        }
        .card-item:active { transform: scale(0.95); }
        .card-item.c-attack { border-bottom-color: #ff4757; background: linear-gradient(180deg, #2f3542 0%, #3e1619 100%); }
        .card-item.c-defense { border-bottom-color: #2ed573; background: linear-gradient(180deg, #2f3542 0%, #113822 100%); }
        .card-item.c-trick { border-bottom-color: #a29bfe; background: linear-gradient(180deg, #2f3542 0%, #262242 100%); }

        #timer-container { width: 100%; height: 6px; background: #2f3640; margin-top: 10px; border-radius: 3px; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--primary); transition: width 1s linear; }

        /* --- MODAL --- */
        #modal-overlay, #modal-guide { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; display: flex; justify-content: center; align-items: flex-end; }
        .modal-box { background: #1e272e; padding: 25px; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; text-align: center; display: flex; flex-direction: column; max-height: 85vh; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .target-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin: 8px 0; background: #2f3542; color: white; border-radius: 12px; }
        
        #screen-winner { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <div id="main-container" class="container">
        <div id="screen-login">
            <svg width="80" height="80" viewBox="0 0 100 100" fill="none" style="margin-bottom: -10px;">
                <path d="M75 10 L40 40 L25 50 L40 60 L75 90 L55 50 Z" stroke="#00FF9D" stroke-width="3" fill="#121212" />
                <circle cx="40" cy="50" r="4" fill="#ff4757" />
            </svg>
            <h1>LUNA<br><span style="color:white; font-size:1.2rem;">GEOMETRY WAR</span></h1>
            <div id="reconnect-msg" style="display:none; color:var(--primary); font-size:12px;">Mencoba menyambung kembali...</div>
            <input type="text" id="username" placeholder="Nama Panggilan" maxlength="10" style="margin-top:20px;">
            <button class="btn-green" onclick="createRoom()">BUAT ROOM BARU</button>
            <p style="font-size:12px; color:#a4b0be; margin: 15px 0;">‚Äî ATAU MASUK ROOM ‚Äî</p>
            <input type="text" id="room-code-input" placeholder="KODE ROOM (CONTOH: A1B2)" style="text-transform:uppercase;">
            <button class="btn-blue" onclick="joinRoom()">GABUNG ROOM</button>
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                 <button class="btn-red" onclick="resetLocalData()" style="font-size:10px; width:auto; padding:8px;">RESET DATA LOKAL</button>
            </div>
        </div>

        <div id="screen-lobby" class="hidden">
            <h2>LOBBY MENUNGGU</h2>
            <div id="display-room-code" style="font-size:3em; font-weight:800; color:var(--primary); letter-spacing: 5px; background:#2f3542; padding:10px; border-radius:10px;">----</div>
            <p style="text-align:left; font-weight:bold;">Daftar Pemain:</p>
            <ul id="player-list-ul" style="list-style:none; padding:0; text-align:left;"></ul>
            <div id="host-controls" class="hidden"><button class="btn-green" onclick="startGame()">MULAI PERTEMPURAN</button></div>
            <p id="waiting-msg" style="color:#a4b0be; font-size:12px;">Menunggu Host memulai...</p>
        </div>

        <div id="screen-game" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div style="background:#2f3542; padding:5px 12px; border-radius:20px; font-weight:bold;">GILIRAN: <span id="turn-name" style="color:var(--primary)">...</span></div>
                <div id="round-info" style="font-size:12px; color:#a4b0be;">RONDE: 1</div>
            </div>
            
            <div id="timer-container"><div id="timer-bar"></div></div>
            <div id="timer-text" style="font-size:10px; text-align:right; margin-bottom:5px; color:#a4b0be;">Waktu: 15s</div>

            <div id="game-board-area">
                <div id="token-layer"></div>
            </div>
            
            <div id="player-controls">
                <div id="dice-container">
                    <div id="dice-1" class="dice">?</div>
                    <div id="dice-2" class="dice">?</div>
                </div>

                <button id="btn-roll" class="btn-green" onclick="handleRollAnim()">üé≤ KOCOK DADU</button>
                
                <div id="host-end-btn" class="hidden" style="margin-top:5px;">
                    <button class="btn-red" onclick="forceEndGame()" style="font-size:10px; padding:8px;">‚ö†Ô∏è SELESAIKAN GAME</button>
                </div>
                
                <div id="game-log" style="height:60px; overflow-y:auto; background:rgba(0,0,0,0.3); font-size:12px; text-align:left; padding:5px; margin:5px 0; border:1px solid #57606f; border-radius:5px;">Log permainan...</div>
                
                <div style="text-align:left; margin-top:10px; font-size:12px; color:white;">INVENTORY KARTU:</div>
                <div id="inventory-area"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-box">
            <h3 style="color:white; margin:0 0 15px 0;">PILIH TARGET</h3>
            <div id="target-list" style="max-height: 250px; overflow-y: auto;"></div>
            <button class="btn-red" onclick="closeModal()" style="margin-top:15px; width:100%;">BATAL</button>
        </div>
    </div>

    <div id="screen-winner" class="hidden">
        <h1 style="font-size:3rem; color:#fdcb6e;">JUARA 1!</h1>
        <h2 id="winner-name-text" style="color:white; font-size:2.5rem;">NAMA</h2>
        <button class="btn-green" style="width:200px; margin-top:30px;" onclick="resetLocalData()">MAIN LAGI</button>
    </div>

    <script type="module">
        // INTEGRASI NAMA DARI LUNA ARCADE (JIKA ADA)
        const savedHubName = localStorage.getItem("ut_name");
        if (savedHubName && !document.getElementById("username").value) {
            document.getElementById("username").value = savedHubName;
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, runTransaction } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBR01mYbrPNVKk5JqMWeNTyr2yDhiXo4Rg",
            authDomain: "ular-tangga-tempur.firebaseapp.com",
            databaseURL: "https://ular-tangga-tempur-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ular-tangga-tempur",
            storageBucket: "ular-tangga-tempur.firebasestorage.app",
            messagingSenderId: "756549951373",
            appId: "1:756549951373:web:1ae57001d93cbd3273a7c4"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ASSETS
        const COLORS = ["#00a8ff", "#9c88ff", "#fbc531", "#4cd137", "#e84118", "#0097e6"];
        const AVATARS = ["ü§ñ", "üëΩ", "üëπ", "ü§°", "üëª", "üëæ", "üéÉ", "üêØ", "üê≤", "üíÄ"];
        const CARD_DB = [
            { id: "SNAKE_STRIKE", name: "Snake Strike", icon: "üêç", desc: "Kirim lawan ke ular belakang.", type: "c-attack", target: "ENEMY" },
            { id: "BACKSTAB", name: "Backstab", icon: "üî™", desc: "Pemimpin mundur 10 langkah.", type: "c-attack", target: "NONE" },
            { id: "TRAP", name: "Trap Set", icon: "üí£", desc: "Pasang Ranjau (Mundur 5).", type: "c-defense", target: "NONE" },
            { id: "NITRO", name: "Nitro", icon: "üöÄ", desc: "Maju 6 langkah.", type: "c-defense", target: "SELF" },
            { id: "PIRATE", name: "Pirate", icon: "üè¥‚Äç‚ò†Ô∏è", desc: "Curi 1 Kartu Lawan.", type: "c-trick", target: "ENEMY" },
            { id: "SKIP", name: "Freeze", icon: "‚ùÑÔ∏è", desc: "Skip giliran lawan.", type: "c-attack", target: "ENEMY" }
        ];

        let myName = "", currentRoomId = "", myPlayerId = "";
        let playerList = [];
        let selectedCardIdx = null, selectedCardData = null;
        let turnTimerInterval = null;
        let isMyTurn = false, amIHost = false;

        // EXPOSE FUNCTION
        window.createRoom = createRoom; window.joinRoom = joinRoom;
        window.startGame = startGame; window.handleRollAnim = handleRollAnim; 
        window.clickCard = clickCard; window.closeModal = closeModal; window.confirmTarget = confirmTarget;
        window.resetLocalData = resetLocalData; window.forceEndGame = forceEndGame;

        // --- RECONNECT LOGIC ---
        (function checkSession() {
            const savedPid = localStorage.getItem("ut_pid");
            const savedRoom = localStorage.getItem("ut_room");
            const savedName = localStorage.getItem("ut_name");
            if(savedPid && savedRoom && savedName) {
                document.getElementById('reconnect-msg').style.display = 'block';
                get(ref(db, `games/${savedRoom}`)).then(snap => {
                    if(snap.exists()) {
                        myPlayerId = savedPid; myName = savedName;
                        enterLobby(savedRoom, snap.val().host === savedPid);
                    } else resetLocalData();
                });
            }
        })();

        function resetLocalData() { localStorage.clear(); location.reload(); }

        // --- MAP GENERATOR ---
        function generateRandomMap() {
            const map = {}; const taken = new Set([1, 100]);
            // Ladders
            for(let i=0; i<6; i++) { 
                let s = Math.floor(Math.random()*80)+2; let e = s + Math.floor(Math.random()*20)+5;
                if(e<100 && !taken.has(s)) { map[s]=e; taken.add(s); taken.add(e); }
            }
            // Snakes
            for(let i=0; i<6; i++) { 
                let h = Math.floor(Math.random()*90)+5; let t = h - Math.floor(Math.random()*30)-5;
                if(t>1 && !taken.has(h)) { map[h]=t; taken.add(h); taken.add(t); }
            }
            // Mystery
            for(let i=0; i<20; i++) {
                let pos = Math.floor(Math.random()*96)+2;
                if(!taken.has(pos)) { map[pos]="?"; taken.add(pos); }
            }
            return map;
        }

        // --- LOBBY SYSTEM ---
        function createRoom() {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("Isi nama dulu!");
            myPlayerId = "p_" + Date.now();
            const roomId = Math.random().toString(36).substring(2,6).toUpperCase();
            
            const pData = { name: myName, isHost: true, position: 1, color: COLORS[0], avatar: AVATARS[0], id: myPlayerId, cards: [] };

            set(ref(db, `games/${roomId}`), {
                status: "LOBBY", host: myPlayerId, turnIndex: 0, lastTurnTime: Date.now(),
                initialBoard: generateRandomMap(), players: { [myPlayerId]: pData }
            }).then(() => {
                localStorage.setItem("ut_pid", myPlayerId); localStorage.setItem("ut_room", roomId); localStorage.setItem("ut_name", myName);
                enterLobby(roomId, true);
            });
        }

        function joinRoom() {
            myName = document.getElementById('username').value.trim();
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if(!myName || !code) return alert("Lengkapi data!");
            myPlayerId = "p_" + Date.now();

            get(ref(db, `games/${code}`)).then(snap => {
                if(snap.exists() && snap.val().status === "LOBBY") {
                    const currentPlayers = Object.keys(snap.val().players || {}).length;
                    if(currentPlayers >= 6) return alert("Room Penuh!");
                    const pData = { name: myName, isHost: false, position: 1, color: COLORS[currentPlayers % COLORS.length], avatar: AVATARS[Math.floor(Math.random()*AVATARS.length)], id: myPlayerId, cards: [] };
                    set(ref(db, `games/${code}/players/${myPlayerId}`), pData).then(() => {
                        localStorage.setItem("ut_pid", myPlayerId); localStorage.setItem("ut_room", code); localStorage.setItem("ut_name", myName);
                        enterLobby(code, false);
                    });
                } else alert("Room tidak tersedia!");
            });
        }

        function enterLobby(roomId, hostStatus) {
            currentRoomId = roomId; amIHost = hostStatus;
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-lobby').classList.remove('hidden');
            document.getElementById('display-room-code').innerText = roomId;
            if(amIHost) document.getElementById('host-controls').classList.remove('hidden');

            onValue(ref(db, `games/${roomId}/players`), snap => {
                if(!snap.exists()) return;
                const list = document.getElementById('player-list-ul'); list.innerHTML = ""; playerList = [];
                snap.forEach(c => { 
                    const p = c.val(); playerList.push(p);
                    list.innerHTML += `<li style="padding:5px; border-left:4px solid ${p.color}; color:white;">${p.avatar} ${p.name}</li>`; 
                });
            });
            onValue(ref(db, `games/${roomId}/status`), snap => {
                if(snap.val() === "PLAYING" || snap.val() === "FINISHED") initGame();
            });
        }

        function startGame() {
            if(!amIHost) return;
            playerList.sort((a,b) => a.id.localeCompare(b.id));
            update(ref(db, `games/${currentRoomId}`), { status: "PLAYING", order: playerList.map(p => p.id), lastTurnTime: Date.now() });
        }

        function forceEndGame() {
            if(confirm("Selesaikan paksa?")) update(ref(db, `games/${currentRoomId}`), { status: "FINISHED", winnerName: "ADMIN" });
        }

        // --- GAME ENGINE ---
        function initGame() {
            document.getElementById('screen-lobby').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            if(amIHost) document.getElementById('host-end-btn').classList.remove('hidden');

            // Render Board Once
            get(ref(db, `games/${currentRoomId}`)).then(snap => {
                const game = snap.val();
                renderBoard(game.initialBoard || {});
            });

            onValue(ref(db, `games/${currentRoomId}`), snap => {
                const game = snap.val();
                if(!game || !game.order) return;

                if(game.status === "FINISHED") {
                    document.getElementById('screen-winner').classList.remove('hidden');
                    document.getElementById('winner-name-text').innerText = game.winnerName;
                    return;
                }

                // Render Tokens (Smooth Movement)
                updateAllTokens(game.players, game.order);
                renderBoardEffects(game.boardEffects || {});

                // Update UI Turn
                const turnPid = game.order[game.turnIndex % game.order.length];
                document.getElementById('turn-name').innerText = game.players[turnPid].name;
                document.getElementById('game-log').innerHTML = (game.logs || []).slice(-5).join("<br>");
                document.getElementById('round-info').innerText = `RND: ${Math.floor(game.turnIndex / game.order.length) + 1}`;
                
                if(game.players[myPlayerId]) renderInventory(game.players[myPlayerId].cards || []);

                // Logic Button & Timer
                isMyTurn = (turnPid === myPlayerId);
                const btn = document.getElementById('btn-roll');
                if(isMyTurn) {
                    btn.disabled = false; btn.className = "btn-green"; btn.innerText = "üé≤ KOCOK DADU";
                } else {
                    btn.disabled = true; btn.className = "btn-disabled"; btn.innerText = "‚è≥ MENUNGGU...";
                }

                // Timer
                if(turnTimerInterval) clearInterval(turnTimerInterval);
                turnTimerInterval = setInterval(() => {
                    const timeLeft = Math.max(0, 15 - Math.floor((Date.now() - (game.lastTurnTime || Date.now()))/1000));
                    document.getElementById('timer-bar').style.width = `${(timeLeft/15)*100}%`;
                    document.getElementById('timer-text').innerText = `${timeLeft}s`;
                    if(timeLeft === 0 && amIHost) { clearInterval(turnTimerInterval); executeRoll(true); }
                }, 1000);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderBoard(map) {
            const board = document.getElementById('game-board-area');
            // Bersihkan tile lama tapi JANGAN hapus #token-layer
            const tiles = board.querySelectorAll('.tile');
            tiles.forEach(t => t.remove());

            for(let i=100; i>=1; i--) {
                const tile = document.createElement('div'); tile.className = 'tile'; tile.id = `tile-${i}`;
                if(map[i]) {
                    if(map[i]==="?") { tile.classList.add('mystery'); tile.innerText="?"; }
                    else if(map[i]>i) { tile.classList.add('ladder'); tile.innerText="‚è´"; }
                    else if(map[i]<i) { tile.classList.add('snake'); tile.innerText="üêç"; }
                } else tile.innerText = i;
                board.appendChild(tile);
            }
        }

        function renderBoardEffects(fx) {
            for(let i=1; i<=100; i++) {
                const tile = document.getElementById(`tile-${i}`);
                if(!tile) continue;
                tile.classList.remove('trap', 'snake'); // Reset fx visual
                if(fx[i]) {
                    if(fx[i].type==="TRAP") { tile.classList.add('trap'); tile.innerText="üí£"; }
                    if(fx[i].type==="SNAKE") { tile.classList.add('snake'); tile.innerText="üêç"; }
                }
            }
        }

        // --- NEW: SMOOTH TOKEN LOGIC ---
        function updateAllTokens(players, order) {
            const layer = document.getElementById('token-layer');
            const boardRect = document.getElementById('game-board-area').getBoundingClientRect();
            const existingTokens = Array.from(layer.children);
            const activeIds = Object.keys(players);

            // Hapus token pemain yg leave
            existingTokens.forEach(el => {
                if(!activeIds.includes(el.dataset.pid)) el.remove();
            });

            for(let pid in players) {
                const p = players[pid];
                let token = document.querySelector(`.token[data-pid="${pid}"]`);
                
                // Create if not exist
                if(!token) {
                    token = document.createElement('div');
                    token.className = `token shape-circle`;
                    token.dataset.pid = pid;
                    token.style.backgroundColor = p.color;
                    token.innerText = p.avatar;
                    layer.appendChild(token);
                }

                // Kalkulasi Posisi
                const targetTile = document.getElementById(`tile-${p.position}`);
                if(targetTile) {
                    // Posisi relatif terhadap board
                    const tileRect = targetTile.getBoundingClientRect();
                    // Koreksi offset agar di tengah kotak
                    const top = tileRect.top - boardRect.top; // + (tileRect.height/2 - token.offsetHeight/2);
                    const left = tileRect.left - boardRect.left; // + (tileRect.width/2 - token.offsetWidth/2);
                    
                    token.style.top = `${top}px`;
                    token.style.left = `${left}px`;
                }

                // Effect Visuals
                if(p.effects?.SKIP) token.style.border = "3px solid cyan";
                else token.style.border = "2px solid white";
            }
        }

        function renderInventory(cards) {
            const div = document.getElementById('inventory-area'); div.innerHTML = "";
            cards.forEach((cid, idx) => {
                const c = CARD_DB.find(x => x.id === cid);
                if(c) div.innerHTML += `<div class="card-item ${c.type}" onclick="clickCard(${idx}, '${cid}')"><span style="font-size:30px">${c.icon}</span><span style="font-size:9px">${c.name}</span></div>`;
            });
        }

        // --- DICE & LOGIC ---
        function handleRollAnim() {
            if(!isMyTurn) return;
            const btn = document.getElementById('btn-roll');
            const d1 = document.getElementById('dice-1');
            const d2 = document.getElementById('dice-2');
            
            btn.disabled = true;
            d1.classList.add('shaking'); d2.classList.add('shaking');

            // Simulasi visual angka random
            let count = 0;
            const intv = setInterval(() => {
                d1.innerText = Math.ceil(Math.random()*6);
                d2.innerText = Math.ceil(Math.random()*6);
                count++;
                if(count > 10) {
                    clearInterval(intv);
                    d1.classList.remove('shaking'); d2.classList.remove('shaking');
                    executeRoll(false);
                }
            }, 80);
        }

        function executeRoll(isAuto) {
            runTransaction(ref(db, `games/${currentRoomId}`), (game) => {
                if(!game) return;
                const totalPlayers = game.order.length;
                if(totalPlayers === 0) return;

                const pid = game.order[(game.turnIndex || 0) % totalPlayers];
                const p = game.players[pid];

                if(!p) { game.turnIndex++; return game; } // Skip error
                if(!isAuto && pid !== myPlayerId) return; // Security check

                let logMsg = isAuto ? "üí§ AFK." : "";

                // Cek Freeze
                if(p.effects?.SKIP) {
                    p.effects.SKIP = null;
                    addLog(game, `‚ùÑÔ∏è ${p.name} beku.`);
                    game.turnIndex++; game.lastTurnTime = Date.now();
                    return game;
                }

                // Roll 2 Dadu
                const roll1 = Math.ceil(Math.random() * 6);
                const roll2 = Math.ceil(Math.random() * 6);
                const totalRoll = roll1 + roll2;
                
                let newPos = (p.position || 1) + totalRoll;
                if(newPos > 100) newPos = 100 - (newPos - 100); // Mantul balik

                // Logika Papan
                const map = game.initialBoard || {};
                const fx = game.boardEffects || {};
                
                if(fx[newPos]) {
                    if(fx[newPos].type === "TRAP") { newPos = Math.max(1, newPos-5); logMsg += " üí£ KENA BOM!"; delete fx[newPos]; } // Bom hilang stlh kena
                    else if(fx[newPos].type === "SNAKE") { newPos = Math.max(1, newPos-10); logMsg += " üêç DIGIGIT!"; }
                } else if(map[newPos]) {
                    if(map[newPos] === "?") {
                        const rand = CARD_DB[Math.floor(Math.random()*CARD_DB.length)];
                        if(!p.cards) p.cards = [];
                        p.cards.push(rand.id);
                        logMsg += ` üé¥ Dapat ${rand.name}!`;
                    } else if(typeof map[newPos] === 'number') {
                        const isUp = map[newPos] > newPos;
                        newPos = map[newPos];
                        logMsg += isUp ? " ‚è´ NAIK TANGGA!" : " üêç TURUN ULAR!";
                    }
                }

                // --- NEW: PREDATOR LOGIC (TABRAK LARI) ---
                if(newPos !== 1) { // Jangan makan di base
                    for(let otherPid in game.players) {
                        if(otherPid !== pid && game.players[otherPid].position === newPos) {
                            game.players[otherPid].position = 1;
                            logMsg += ` ‚öîÔ∏è MENENDANG ${game.players[otherPid].name}!`;
                        }
                    }
                }

                p.position = newPos;
                if(newPos === 100) { game.status = "FINISHED"; game.winnerName = p.name; }

                addLog(game, `> ${p.name} (Roll ${totalRoll}) ke ${newPos}. ${logMsg}`);
                game.turnIndex++;
                game.lastTurnTime = Date.now();
                return game;
            });
        }

        // --- CARD LOGIC ---
        function clickCard(idx, cid) {
            if(!isMyTurn) return alert("Bukan giliranmu!");
            const c = CARD_DB.find(x => x.id === cid);
            selectedCardIdx = idx; selectedCardData = c;
            
            if(c.target === "ENEMY") showTargetModal();
            else if(confirm(`Gunakan ${c.name}?`)) executeCard(null);
        }

        function showTargetModal() {
            const list = document.getElementById('target-list'); list.innerHTML = "";
            playerList.forEach(p => {
                if(p.id !== myPlayerId) {
                    list.innerHTML += `<button class="target-btn" onclick="confirmTarget('${p.id}')">
                        <span>${p.avatar} ${p.name}</span> <span style="font-size:12px; color:#aaa">Pos: ${p.position}</span>
                    </button>`;
                }
            });
            if(!list.innerHTML) list.innerHTML = "<p>Tidak ada musuh.</p>";
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function confirmTarget(tid) { closeModal(); executeCard(tid); }

        function executeCard(targetId) {
            runTransaction(ref(db, `games/${currentRoomId}`), (game) => {
                if(!game) return;
                const me = game.players[myPlayerId];
                const cid = selectedCardData.id;

                if(cid === "NITRO") me.position = Math.min(100, me.position + 6);
                if(cid === "BACKSTAB") {
                    let leadId = null, max = 0;
                    for(let pid in game.players) if(game.players[pid].position > max) { max = game.players[pid].position; leadId = pid; }
                    if(leadId) game.players[leadId].position = Math.max(1, game.players[leadId].position - 10);
                }
                if(cid === "TRAP") { 
                    if(!game.boardEffects) game.boardEffects = {};
                    game.boardEffects[me.position] = { type: "TRAP" };
                }
                if(cid === "SKIP" && targetId) {
                    if(!game.players[targetId].effects) game.players[targetId].effects = {};
                    game.players[targetId].effects.SKIP = true;
                }
                if(cid === "SNAKE_STRIKE" && targetId) game.players[targetId].position = Math.max(1, game.players[targetId].position - 10); 
                if(cid === "PIRATE" && targetId) {
                    const enemyCards = game.players[targetId].cards;
                    if(enemyCards && enemyCards.length > 0) {
                        const stolen = enemyCards.pop();
                        if(!me.cards) me.cards = [];
                        me.cards.push(stolen);
                    }
                }

                me.cards.splice(selectedCardIdx, 1);
                addLog(game, `‚ö° ${me.name} pakai ${selectedCardData.name}`);
                return game;
            });
        }

        function addLog(game, msg) { if(!game.logs) game.logs=[]; game.logs.push(msg); }
    </script>
</body>
</html>